<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Chicken - Advanced Admin</title>
    <style>
        :root { --primary: #8b4513; --secondary: #d2a679; --success: #28a745; --danger: #dc3545; --light: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 0.9em; color: #666; text-transform: uppercase; }
        .stat-card .value { font-size: 1.8em; font-weight: bold; margin-top: 10px; color: var(--primary); }

        /* Tables & Sections */
        section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid var(--secondary); padding-bottom: 10px; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; background: #eee; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Status Badges */
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .pending { background: #fff3cd; color: #856404; }
        .completed { background: #d4edda; color: #155724; }

        /* Forms */
        .flex-form { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 15px; transition: 0.3s; }
        .btn-add { background: var(--primary); color: white; }
        .btn-complete { background: var(--success); color: white; }
        .btn-delete { background: var(--danger); color: white; font-size: 0.8em; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<div class="container">
    <h1>üöÄ Let's Chicken: Business Insights</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Monthly Income (Gross)</h3>
            <div id="grossIncome" class="value">R0.00</div>
        </div>
        <div class="stat-card">
            <h3>Monthly Expenses/Losses</h3>
            <div id="totalExpenses" class="value" style="color: var(--danger)">R0.00</div>
        </div>
        <div class="stat-card">
            <h3>Net Profit</h3>
            <div id="netProfit" class="value" style="color: var(--success)">R0.00</div>
        </div>
        <div class="stat-card">
            <h3>Pending Orders</h3>
            <div id="pendingCount" class="value">0</div>
        </div>
    </div>

    <section>
        <h2>Record Expense / Loss</h2>
        <form class="flex-form" id="expenseForm">
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="expDesc" placeholder="e.g. 50kg Feed, Mortality" required>
            </div>
            <div class="form-group">
                <label>Amount (R)</label>
                <input type="number" id="expAmount" step="0.01" required>
            </div>
            <button type="submit" class="btn-add">Log Expense</button>
        </form>
    </section>

    <section>
        <h2>Recent Orders</h2>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="orderList"></tbody>
        </table>
    </section>
</div>

<script>
    // Firebase Config (Same as your main site)
    const firebaseConfig = {
      apiKey: "AIzaSyDUJGDr9lr4RIKypHiefHDeMTnwQ63-2V4",
      authDomain: "let-s-chicken.firebaseapp.com",
      databaseURL: "https://let-s-chicken-default-rtdb.firebaseio.com",
      projectId: "let-s-chicken",
      storageBucket: "let-s-chicken.firebasestorage.app",
      messagingSenderId: "924154280207",
      appId: "1:924154280207:web:79d6d77e2c316329b7267a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gross = 0;
    let expenses = 0;

    // --- ORDER LOGIC ---
    db.ref('orders').on('value', (snap) => {
        const list = document.getElementById('orderList');
        list.innerHTML = '';
        gross = 0;
        let pending = 0;

        snap.forEach((child) => {
            const order = child.val();
            const id = child.key;
            const isDone = order.status === 'Completed';
            
            // Calculate Gross Income (Only from completed orders)
            const numericTotal = parseFloat(order.total.replace('R', '')) || 0;
            if(isDone) gross += numericTotal;
            else pending++;

            const row = `
                <tr>
                    <td>${new Date(order.timestamp).toLocaleDateString()}</td>
                    <td><strong>${order.name}</strong><br><small>${order.phone}</small></td>
                    <td>${order.quantity}x ${order.product}</td>
                    <td>${order.total}</td>
                    <td><span class="badge ${isDone ? 'completed' : 'pending'}">${order.status || 'Pending'}</span></td>
                    <td>
                        ${!isDone ? `<button class="btn-complete" onclick="markComplete('${id}')">Complete</button>` : ''}
                        <button class="btn-delete" onclick="deleteItem('orders/${id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
            list.insertAdjacentHTML('afterbegin', row);
        });
        document.getElementById('grossIncome').textContent = 'R' + gross.toFixed(2);
        document.getElementById('pendingCount').textContent = pending;
        updateNet();
    });

    // --- EXPENSE LOGIC ---
    document.getElementById('expenseForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = document.getElementById('expDesc').value;
        const amt = parseFloat(document.getElementById('expAmount').value);
        
        db.ref('expenses').push({
            description: desc,
            amount: amt,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            e.target.reset();
        });
    });

    db.ref('expenses').on('value', (snap) => {
        expenses = 0;
        snap.forEach((child) => {
            expenses += child.val().amount;
        });
        document.getElementById('totalExpenses').textContent = 'R' + expenses.toFixed(2);
        updateNet();
    });

    function updateNet() {
        const net = gross - expenses;
        const el = document.getElementById('netProfit');
        el.textContent = 'R' + net.toFixed(2);
        el.style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    function markComplete(id) {
        db.ref('orders/' + id).update({ status: 'Completed' });
    }

    function deleteItem(path) {
        if(confirm("Delete this record permanently?")) db.ref(path).remove();
    }
</script>
</body>
</html>
