<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Chicken - Admin Dashboard</title>
    <!-- Bootstrap CSS CDN for modern UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #f4f4f4; color: #333; }
        .navbar { background: #d2a679; }
        .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #ordersTable { width: 100%; }
        .status-pending { color: orange; font-weight: bold; }
        .status-completed { color: green; font-weight: bold; }
        .status-cancelled { color: red; font-weight: bold; }
        footer { background: #8b4513; color: white; text-align: center; padding: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Let's Chicken Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn" style="display: none;">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Login Form -->
        <div id="loginSection" class="card p-4 mb-4">
            <h2 class="text-center">Admin Login</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password:</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
            <p class="text-center mt-3" id="loginError" style="color: red;"></p>
        </div>

        <!-- Dashboard (hidden initially) -->
        <div id="dashboardSection" style="display: none;">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center p-3">
                        <h5>Total Orders</h5>
                        <h3 id="totalOrders">0</h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center p-3">
                        <h5>Total Revenue</h5>
                        <h3 id="totalRevenue">R0.00</h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center p-3">
                        <h5>Pending Orders</h5>
                        <h3 id="pendingOrders">0</h3>
                    </div>
                </div>
            </div>

            <!-- Orders Chart -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Orders Over Time</h5>
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="card mb-4 p-3">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by Name or Phone">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-secondary" id="exportCsv">Export to CSV</button>
                    </div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Orders List</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Notes</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-4">
        Â© 2026 Let's Chicken. All rights reserved.
    </footer>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // Firebase Configuration (same as main site)
        const firebaseConfig = {
            apiKey: "AIzaSyDUJGDr9lr4RIKypHiefHDeMTnwQ63-2V4",
            authDomain: "let-s-chicken.firebaseapp.com",
            databaseURL: "https://let-s-chicken-default-rtdb.firebaseio.com",
            projectId: "let-s-chicken",
            storageBucket: "let-s-chicken.firebasestorage.app",
            messagingSenderId: "924154280207",
            appId: "1:924154280207:web:79d6d77e2c316329b7267a",
            measurementId: "G-YXXM4ZJ9BQ"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let ordersData = []; // Store all orders for filtering/export
        let ordersChart;

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
                loadOrders();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        });

        // Login Form Submit
        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // Logged in
                })
                .catch(error => {
                    document.getElementById('loginError').textContent = error.message;
                });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // Load Orders from Firebase
        function loadOrders() {
            database.ref('orders').on('value', snapshot => {
                ordersData = [];
                let totalOrders = 0;
                let totalRevenue = 0;
                let pendingOrders = 0;
                const ordersBody = document.getElementById('ordersBody');
                ordersBody.innerHTML = '';
                const chartData = {}; // For orders over time

                snapshot.forEach(child => {
                    const order = child.val();
                    const id = child.key;
                    const status = order.status || 'pending'; // Default to pending if not set
                    ordersData.push({ id, ...order, status });

                    totalOrders++;
                    totalRevenue += parseFloat(order.total.replace('R', '')) || 0;
                    if (status === 'pending') pendingOrders++;

                    // Date for chart (group by date)
                    const date = new Date(order.timestamp).toLocaleDateString();
                    chartData[date] = (chartData[date] || 0) + 1;

                    // Row
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${id}</td>
                        <td>${order.name}</td>
                        <td>${order.phone}</td>
                        <td>${order.product}</td>
                        <td>${order.quantity}</td>
                        <td>${order.total}</td>
                        <td>${order.notes || ''}</td>
                        <td>${new Date(order.timestamp).toLocaleString()}</td>
                        <td class="status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</td>
                        <td>
                            <select class="form-select form-select-sm statusSelect" data-id="${id}">
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button class="btn btn-sm btn-danger deleteBtn" data-id="${id}">Delete</button>
                        </td>
                    `;
                    ordersBody.appendChild(row);
                });

                // Update stats
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('totalRevenue').textContent = 'R' + totalRevenue.toFixed(2);
                document.getElementById('pendingOrders').textContent = pendingOrders;

                // Update chart
                updateChart(chartData);

                // Attach event listeners
                attachEventListeners();
            });
        }

        // Update Status
        function updateStatus(id, newStatus) {
            database.ref(`orders/${id}`).update({ status: newStatus });
        }

        // Delete Order
        function deleteOrder(id) {
            if (confirm('Are you sure you want to delete this order?')) {
                database.ref(`orders/${id}`).remove();
            }
        }

        // Attach listeners to buttons/selects
        function attachEventListeners() {
            document.querySelectorAll('.statusSelect').forEach(select => {
                select.addEventListener('change', e => {
                    const id = e.target.dataset.id;
                    const newStatus = e.target.value;
                    updateStatus(id, newStatus);
                });
            });
            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const id = e.target.dataset.id;
                    deleteOrder(id);
                });
            });
        }

        // Update Chart
        function updateChart(chartData) {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            const labels = Object.keys(chartData).sort();
            const data = labels.map(label => chartData[label]);

            if (ordersChart) ordersChart.destroy();
            ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Orders per Day',
                        data: data,
                        borderColor: '#8b4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Search and Filter
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        [searchInput, statusFilter].forEach(el => {
            el.addEventListener('input', filterOrders);
        });

        function filterOrders() {
            const searchTerm = searchInput.value.toLowerCase();
            const status = statusFilter.value;
            const rows = document.querySelectorAll('#ordersBody tr');
            rows.forEach(row => {
                const name = row.children[1].textContent.toLowerCase();
                const phone = row.children[2].textContent.toLowerCase();
                const rowStatus = row.children[8].textContent.toLowerCase();
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesStatus = !status || rowStatus === status;
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        // Export to CSV
        document.getElementById('exportCsv').addEventListener('click', () => {
            let csv = 'ID,Name,Phone,Product,Quantity,Total,Notes,Date,Status\n';
            ordersData.forEach(order => {
                csv += `${order.id},${order.name},${order.phone},${order.product},${order.quantity},${order.total},${order.notes || ''},${new Date(order.timestamp).toLocaleString()},${order.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'orders.csv';
            link.click();
        });
    </script>
</body>
</html>

